<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Estación Cenmeteopmo 85802</title>

<style>
:root {
  --bg: #f9fafb;
  --card-bg: rgba(255, 255, 255, 0.85);
  --accent: #1e88e5;
  --text-primary: #0d47a1;
  --text-secondary: #1565c0;
  --shadow: 0 10px 20px rgba(0,0,0,0.08);
  --radius: 16px;
  --transition: 0.3s ease;
}

body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(120deg, #e3f2fd, #ffffff);
  margin: 0;
  padding: 20px;
  position: relative;
  min-height: 100vh;
}

/* ===== Marca de agua ===== */
body::before {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: url('https://ia600206.us.archive.org/22/items/imagen_mejorada_3D/LOGO%20METEOPMO.png'); 
  background-repeat: no-repeat;
  background-position: center;
  background-size: 50% auto;
  opacity: 0.08;
  z-index: 0;
  pointer-events: none;
}

/* ===== Cabecera ===== */
.title {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin-bottom: 10px;
  font-size: 28px;
  color: var(--text-primary);
  text-shadow: 1px 1px 2px rgba(0,0,0,0.08);
  position: relative;
  z-index: 1;
}
.title-logo {
  width: 80px;
  height: auto;
}

h2 {
  text-align: center;
  margin-bottom: 20px;
  font-size: 16px;
  color: var(--text-primary);
  text-shadow: 1px 1px 2px rgba(0,0,0,0.08);
  position: relative;
  z-index: 1;
}

/* ===== Tarjetas verticales ===== */
.grid {
  display: flex;
  flex-direction: column;
  gap: 16px;
  max-width: 400px;
  margin: auto;
  position: relative;
  z-index: 1;
}

.card {
  background: var(--card-bg);
  backdrop-filter: blur(10px);
  border-radius: var(--radius);
  padding: 18px;
  box-shadow: var(--shadow);
  display: flex;
  flex-direction: column;
  align-items: center;
  transition: transform var(--transition), box-shadow var(--transition);
  text-align: center;
}

.card:hover {
  transform: translateY(-6px);
  box-shadow: 0 15px 25px rgba(0,0,0,0.12);
}

.label {
  font-size: 14px;
  color: var(--accent);
  font-weight: 700;
  margin-bottom: 6px;
}

.value {
  font-size: 22px;
  font-weight: 800;
  color: var(--text-secondary);
}

#status {
  text-align: center;
  font-size: 14px;
  color: var(--text-secondary);
  margin-top: 25px;
  font-weight: 600;
  position: relative;
  z-index: 1;
}

.credit {
  text-align: center;
  font-size: 13px;
  font-family: 'Segoe UI', sans-serif;
  color: #0d47a1;
  margin-top: 40px;
  background: rgba(187, 222, 251, 0.8);
  padding: 12px 0;
  border-radius: var(--radius);
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  position: relative;
  z-index: 1;
}
.credit span {
  font-weight: 700;
  color: #0d47a1;
}

@media (max-width: 500px) {
  .title { font-size: 22px; }
  .value { font-size: 20px; }
}
</style>
</head>
<body>

<h1 class="title">
  <img src="https://ia600206.us.archive.org/22/items/imagen_mejorada_3D/LOGO%20METEOPMO.png" alt="Logo" class="title-logo">
  Estación Meteorológica - Puerto Montt
</h1>
<h2>Código OMM 85802 - Código Nacional 410932</h2>

<div class="grid" id="grid">
  <div class="card"><div class="label">Temperatura actual</div><div id="temp_actual" class="value">--</div></div>
  <div class="card"><div class="label">Temperatura húmeda</div><div id="temp_humeda" class="value">--</div></div>
  <div class="card"><div class="label">Punto de rocío</div><div id="punto_rocio" class="value">--</div></div>
  <div class="card"><div class="label">Humedad relativa</div><div id="humedad" class="value">--</div></div>
  <div class="card"><div class="label">Viento</div><div id="viento_unido" class="value">--</div></div>
  <div class="card"><div class="label">Rachas</div><div id="racha" class="value">--</div></div>
  <div class="card"><div class="label">Presión atmosférica E.M.A</div><div id="presion" class="value">--</div></div>
<div class="card">
  <div class="label">Presión corregida PTU</div>
  <div id="presion_corregida" class="value">--</div>
</div>

  <div class="card"><div class="label">Precipitación</div><div id="lluvia" class="value">--</div></div>
  <div class="card"><div class="label">Temperatura Máxima</div><div id="temp_max" class="value">--</div></div>
  <div class="card"><div class="label">Temperatura Mínima</div><div id="temp_min" class="value">--</div></div>
  <div class="card"><div class="label">Última actualización</div><div id="ultima" class="value">--</div></div>
</div>

<div id="status">Estado: esperando primera lectura...</div>

<footer class="credit">
  <span>Cabo 2º (Met.) Francisco Salas Muñoz</span>
</footer>

<script>
// ===== Funciones meteorológicas =====
function parseTimestamp(ts){
  if(!ts) return "--";
  let d = isNaN(ts)? new Date(ts) : new Date(Number(ts)>1e12? Number(ts) : Number(ts)*1000);
  if(!d || isNaN(d.getTime())) return "--";
  return d.toLocaleString("es-CL",{year:"numeric",month:"2-digit",day:"2-digit",hour12:false,hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:"America/Santiago"});
}

function getField(obj,names){
  for(const n of names){
    if(!obj) break;
    if(Object.prototype.hasOwnProperty.call(obj,n) && obj[n]!=null) return obj[n];
    const low = Object.keys(obj).find(k=>k.toLowerCase()===n.toLowerCase());
    if(low) return obj[low];
  }
  return undefined;
}

function convertirHoraMs(ms){
  if(!ms) return '--';
  const d = new Date(Number(ms));
  if(isNaN(d)) return '--';
  return d.toLocaleString("es-CL",{hour12:false,hour:"2-digit",minute:"2-digit",second:"2-digit",day:"2-digit",month:"2-digit",year:"numeric",timeZone:"America/Santiago"});
}

function calcDewPoint_Magnus(T,RH){const a=17.27,b=237.7;const alpha=(a*T)/(b+T)+Math.log(Math.max(RH,0.01)/100);return (b*alpha)/(a-alpha);}
function calcRH_from_T_Td(T,Td){const a=17.27,b=237.7;const es_T=6.112*Math.exp((a*T)/(b+T));const e_Td=6.112*Math.exp((a*Td)/(b+Td));return Math.min(100,Math.max(0,(e_Td/es_T)*100));}
function calcWetBulb_Stull(T,RH){return T*Math.atan(0.151977*Math.sqrt(RH+8.313659))+Math.atan(T+RH)-Math.atan(RH-1.676331)+0.00391838*Math.pow(RH,1.5)*Math.atan(0.023101*RH)-4.686035;}

// ===== Cargar y mostrar datos =====
async function cargarYProcesar(){
  const statusEl = document.getElementById('status');
  try{
    statusEl.textContent = 'Estado: consultando WeatherLink...';
    const url = 'https://corsproxy.io/?https://www.weatherlink.com/embeddablePage/getData/6a3a4e7ae8ab409d8b9f43d3d188e50b';
    const r = await fetch(url,{cache:"no-store"});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const datos = await r.json();

    const temp = Number(getField(datos,['temperature','temp','air_temperature','airTemp','temp_c']));
    const dewFromApi = getField(datos,['dewPoint','dew_point','dewpoint','dew','td']);
    const humidity = Number(getField(datos,['humidity','hum','relative_humidity','rh']));
    const hiTemp = getField(datos,['hiTemp','tempHigh']);
    const hiTempDate = getField(datos,['hiTempDate','tempHighDate']);
    const loTemp = getField(datos,['loTemp','tempLow']);
    const loTempDate = getField(datos,['loTempDate','tempLowDate']);
    const baro = getField(datos,['barometer','pressure']);
    const rain = getField(datos,['rain','rain_day','rain_mm']);
    const windSpeed = getField(datos,['wind','windspeed','wind_speed','windSpeed']);
    const gust = getField(datos,['gust','windgust']);
    const windDir = getField(datos,['windDirection','wind_dir','winddirection','dir']);

    const haveT = !Number.isNaN(temp);
    const haveRH = !Number.isNaN(humidity);
    const haveTdApi = (dewFromApi!==undefined && dewFromApi!==null && dewFromApi!=='');

    if(!haveT){ statusEl.textContent='Error: temperatura no disponible.'; return; }

    let Td=NaN; if(haveTdApi) Td=Number(dewFromApi); else if(haveRH) Td=calcDewPoint_Magnus(temp,humidity);
    let RH_used=NaN; if(!Number.isNaN(Td)) RH_used=calcRH_from_T_Td(temp,Td); else if(haveRH) RH_used=humidity;
    let Tw=NaN; if(!Number.isNaN(RH_used)) Tw=calcWetBulb_Stull(temp,RH_used);

    const f=(v,dp=1)=>(v===undefined||v===null||Number.isNaN(Number(v)))?'--':Number(v).toFixed(dp);

    // ===== Valores y colores dinámicos =====
    function setColor(el,value,type){
      if(value==='--') return;
      value = Number(value);
      switch(type){
        case 'temp': 
          el.style.color = value<0?'blue':value<=20?'green':'red'; break;
        case 'dew': 
          el.style.color = value<0?'blue':value<=15?'green':'red'; break;
        case 'hum': 
          el.style.color = value<30?'orange':value<=70?'green':'blue'; break;
        case 'baro':
          el.style.color = value<1000?'red':value<=1025?'green':'blue'; break;
        case 'wind':
          el.style.color = value<10?'green':value<=20?'orange':'red'; break;
        case 'rain':
          el.style.color = value===0?'gray':value<=5?'blue':'darkblue'; break;
      }
    }

    const tempEl = document.getElementById('temp_actual'); tempEl.textContent=f(temp,1)+' °C'; setColor(tempEl,temp,'temp');
    const humEl = document.getElementById('humedad'); humEl.textContent=haveRH?f(humidity,0)+' %':'--'; setColor(humEl,humidity,'hum');
    const dewEl = document.getElementById('punto_rocio'); dewEl.textContent=!Number.isNaN(Td)?f(Td,1)+' °C':'--'; setColor(dewEl,Td,'dew');
    const twEl = document.getElementById('temp_humeda'); twEl.textContent=!Number.isNaN(Tw)?f(Tw+0.3,1)+' °C':'--'; setColor(twEl,Tw,'temp');

    const maxHora = convertirHoraMs(hiTempDate);
    const minHora = convertirHoraMs(loTempDate);
    document.getElementById('temp_max').textContent = hiTemp!==undefined?`${hiTemp} °C — ${maxHora}`:'--';
    document.getElementById('temp_min').textContent = loTemp!==undefined?`${loTemp} °C — ${minHora}`:'--';

    const presEl = document.getElementById('presion'); presEl.textContent = baro!==undefined?String(baro)+' hPa':'--'; setColor(presEl,baro,'baro');

// ===== PRESIÓN CORREGIDA =====
// Cambia este número si deseas otro ajuste
const ajustePresion = 1.2;

const presionCorregida = 
  (baro !== undefined && !isNaN(Number(baro))) 
  ? (Number(baro) + ajustePresion).toFixed(1)
  : '--';

const presionCorregidaEl = document.getElementById('presion_corregida');
presionCorregidaEl.textContent = presionCorregida !== '--' 
  ? presionCorregida + ' hPa' 
  : '--';

// aplicar color dinámico igual que presión normal
setColor(presionCorregidaEl, presionCorregida, 'baro');


    const lluviaEl = document.getElementById('lluvia'); lluviaEl.textContent = rain!==undefined?String(rain)+' mm':'--'; setColor(lluviaEl,rain,'rain');

    const windEl = document.getElementById('viento_unido'); windEl.textContent = (windDir!==undefined?windDir:'--')+'° / '+(windSpeed!==undefined?windSpeed+' Nds':'--'); setColor(windEl,windSpeed,'wind');
    const gustEl = document.getElementById('racha'); gustEl.textContent = gust!==undefined?String(gust)+' Nds':'--'; setColor(gustEl,gust,'wind');

    const ts = getField(datos,['lastReceived','ts','timestamp','lastUpdate','lastupdate','last_update','updateTime','updatetime','time']);
    document.getElementById('ultima').textContent = parseTimestamp(ts);

    statusEl.textContent = 'Estado: datos cargados correctamente';
  } catch(err){
    console.error(err);
    statusEl.textContent = 'Error al cargar datos: '+err.message;
  }
}

cargarYProcesar();
setInterval(cargarYProcesar,30000);
</script>

</body>
</html>
